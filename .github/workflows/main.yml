name: Run KaneAI Tests on LambdaTest

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  kaneai-test:
    runs-on: ubuntu-latest

    steps:
      - name: Trigger KaneAI Test on LambdaTest
        run: |
          echo "Triggering KaneAI tests on LambdaTest"
          
          # Encode the username:access_key in Base64
          auth=$(echo -n "anubhas:m3LQbTWIR6qzNAuBBUNlnWW4Wl2pdq7iiWhrinFIu7sPDL3ANm" | base64)

          response=$(curl --location 'https://test-manager-api.lambdatest.com/api/atm/v1/hyperexecute' \
            --header "accept: application/json" \
            --header "Content-Type: application/json" \
            --header "Authorization: Basic $auth" \
            --data '{
                "test_run_id": "01JRZ364TD2AHEMKR6NK3QZKNZ",
                "concurrency": 1
            }')
          
          echo "Response: $response"

      - name: Wait and Check Test Status
        run: |
          echo "Waiting for test completion..."
          sleep 240  # Wait for test to run before checking status

          # No job ID is being fetched here, just checking the test completion status directly
          response=$(curl --location "https://api.hyperexecute.cloud/v2.0/job/status" \
            --header "accept: application/json" \
            --header "Authorization: Basic $auth" )

          echo "Response: $response"
          status=$(echo $response | jq -r '.data.status')
          echo "Test status: $status"

          if [[ "$status" != "completed" ]]; then
            echo "Tests failed or not completed yet."
            exit 1
          fi

          echo "âœ… KaneAI tests passed successfully!"
