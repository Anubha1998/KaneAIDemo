name: Run KaneAI Tests on LambdaTest

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  kaneai-test:
    runs-on: ubuntu-latest

    steps:
      - name: Trigger KaneAI Test on LambdaTest
        id: trigger-test
        run: |
          echo "Triggering KaneAI tests on LambdaTest"

          # Base64 for: anubhas:m3LQbTWIR6qzNAuBBUNlnWW4Wl2pdq7iiWhrinFIu7sPDL3ANm
          LT_BASIC_AUTH="YW51YmhhczptM0xRYlRXSVI2cXpOQXVCQlVObG5XVzR3bDJwZHE3aWlXaHJpbkZJdTdzUERMM0FObQ=="

          response=$(curl --fail --location 'https://test-manager-api.lambdatest.com/api/atm/v1/hyperexecute' \
            --header 'accept: application/json' \
            --header 'Content-Type: application/json' \
            --header "Authorization: Basic $LT_BASIC_AUTH" \
            --data '{"test_run_id": "01JRZ364TD2AHEMKR6NK3QZKNZ", "concurrency": 1}' )

          echo "Raw response: $response"

          app_job_id=$(echo "$response" | jq -r '.app_job_id')
          echo "Extracted app_job_id: $app_job_id"

          if [[ "$app_job_id" == "null" || -z "$app_job_id" ]]; then
            echo "❌ Failed to extract app_job_id."
            exit 1
          fi

          echo "app_job_id=$app_job_id" >> "$GITHUB_ENV"

      - name: Wait and Check Test Status
        run: |
          echo "Waiting for test completion..."
          sleep 240

          echo "Checking status of job: $app_job_id"

          LT_BASIC_AUTH="YW51YmhhczptM0xRYlRXSVI2cXpOQXVCQlVObG5XVzR3bDJwZHE3aWlXaHJpbkZJdTdzUERMM0FObQ=="

          response=$(curl --location "https://api.hyperexecute.cloud/v2.0/job/$app_job_id" \
            --header "accept: application/json" \
            --header "Authorization: Basic $LT_BASIC_AUTH")

          echo "Response: $response"
          status=$(echo "$response" | jq -r '.data.status')
          echo "Test status: $status"

          if [[ "$status" != "completed" ]]; then
            echo "❌ Tests failed or not completed yet."
            exit 1
          fi

          echo "✅ KaneAI tests passed successfully!"
